import { PrismaClient } from '@prisma/client';
import bcrypt from 'bcryptjs';

const prisma = new PrismaClient();

async function main() {
  console.log('üå± Iniciando seed do banco de dados...');

  // Criar categorias
  console.log('üìÇ Criando categorias...');
  const categories = await Promise.all([
    prisma.category.upsert({
      where: { slug: 'programacao' },
      update: {},
      create: {
        name: 'Programa√ß√£o',
        slug: 'programacao',
        description: 'Quest√µes sobre desenvolvimento de software, algoritmos e linguagens de programa√ß√£o',
        icon: 'üíª',
        color: '#3B82F6',
        order: 1,
      },
    }),
    prisma.category.upsert({
      where: { slug: 'web-development' },
      update: {},
      create: {
        name: 'Desenvolvimento Web',
        slug: 'web-development',
        description: 'Frontend, backend, frameworks e tecnologias web',
        icon: 'üåê',
        color: '#10B981',
        order: 2,
      },
    }),
    prisma.category.upsert({
      where: { slug: 'mobile-development' },
      update: {},
      create: {
        name: 'Desenvolvimento Mobile',
        slug: 'mobile-development',
        description: 'Desenvolvimento para iOS, Android e aplica√ß√µes m√≥veis',
        icon: 'üì±',
        color: '#F59E0B',
        order: 3,
      },
    }),
    prisma.category.upsert({
      where: { slug: 'database' },
      update: {},
      create: {
        name: 'Banco de Dados',
        slug: 'database',
        description: 'SQL, NoSQL, modelagem e administra√ß√£o de bancos',
        icon: 'üóÑÔ∏è',
        color: '#8B5CF6',
        order: 4,
      },
    }),
    prisma.category.upsert({
      where: { slug: 'devops' },
      update: {},
      create: {
        name: 'DevOps',
        slug: 'devops',
        description: 'CI/CD, containers, cloud e infraestrutura',
        icon: 'üöÄ',
        color: '#EF4444',
        order: 5,
      },
    }),
    prisma.category.upsert({
      where: { slug: 'ai-ml' },
      update: {},
      create: {
        name: 'IA e Machine Learning',
        slug: 'ai-ml',
        description: 'Intelig√™ncia artificial, aprendizado de m√°quina e an√°lise de dados',
        icon: 'ü§ñ',
        color: '#EC4899',
        order: 6,
      },
    }),
  ]);

  console.log(`‚úÖ ${categories.length} categorias criadas`);

  // Criar tags
  console.log('üè∑Ô∏è Criando tags...');
  const tags = await Promise.all([
    prisma.tag.upsert({
      where: { slug: 'javascript' },
      update: {},
      create: {
        name: 'JavaScript',
        slug: 'javascript',
        description: 'Linguagem de programa√ß√£o JavaScript e ECMAScript',
        color: '#F7DF1E',
        isPopular: true,
        usageCount: 0,
      },
    }),
    prisma.tag.upsert({
      where: { slug: 'python' },
      update: {},
      create: {
        name: 'Python',
        slug: 'python',
        description: 'Linguagem de programa√ß√£o Python',
        color: '#3776AB',
        isPopular: true,
        usageCount: 0,
      },
    }),
    prisma.tag.upsert({
      where: { slug: 'react' },
      update: {},
      create: {
        name: 'React',
        slug: 'react',
        description: 'Biblioteca JavaScript para interfaces de usu√°rio',
        color: '#61DAFB',
        isPopular: true,
        usageCount: 0,
      },
    }),
    prisma.tag.upsert({
      where: { slug: 'nodejs' },
      update: {},
      create: {
        name: 'Node.js',
        slug: 'nodejs',
        description: 'Runtime JavaScript para servidor',
        color: '#339933',
        isPopular: true,
        usageCount: 0,
      },
    }),
    prisma.tag.upsert({
      where: { slug: 'typescript' },
      update: {},
      create: {
        name: 'TypeScript',
        slug: 'typescript',
        description: 'Superset tipado de JavaScript',
        color: '#3178C6',
        isPopular: true,
        usageCount: 0,
      },
    }),
    prisma.tag.upsert({
      where: { slug: 'nextjs' },
      update: {},
      create: {
        name: 'Next.js',
        slug: 'nextjs',
        description: 'Framework React para produ√ß√£o',
        color: '#000000',
        isNew: true,
        usageCount: 0,
      },
    }),
    prisma.tag.upsert({
      where: { slug: 'postgresql' },
      update: {},
      create: {
        name: 'PostgreSQL',
        slug: 'postgresql',
        description: 'Sistema de banco de dados relacional',
        color: '#336791',
        isPopular: true,
        usageCount: 0,
      },
    }),
    prisma.tag.upsert({
      where: { slug: 'docker' },
      update: {},
      create: {
        name: 'Docker',
        slug: 'docker',
        description: 'Plataforma de containeriza√ß√£o',
        color: '#2496ED',
        isPopular: true,
        usageCount: 0,
      },
    }),
  ]);

  console.log(`‚úÖ ${tags.length} tags criadas`);

  // Criar badges
  console.log('üèÜ Criando badges...');
  const badges = await Promise.all([
    prisma.badge.upsert({
      where: { name: 'Primeira Pergunta' },
      update: {},
      create: {
        name: 'Primeira Pergunta',
        description: 'Fez sua primeira pergunta no f√≥rum',
        icon: 'üéØ',
        color: '#3B82F6',
        criteria: 'Fazer pelo menos uma pergunta',
      },
    }),
    prisma.badge.upsert({
      where: { name: 'Primeira Resposta' },
      update: {},
      create: {
        name: 'Primeira Resposta',
        description: 'Deu sua primeira resposta no f√≥rum',
        icon: 'üí°',
        color: '#10B981',
        criteria: 'Dar pelo menos uma resposta',
      },
    }),
    prisma.badge.upsert({
      where: { name: 'Resposta Aceita' },
      update: {},
      create: {
        name: 'Resposta Aceita',
        description: 'Teve uma resposta aceita como melhor resposta',
        icon: '‚úÖ',
        color: '#F59E0B',
        criteria: 'Ter uma resposta marcada como aceita',
      },
    }),
    prisma.badge.upsert({
      where: { name: 'Contribuidor Ativo' },
      update: {},
      create: {
        name: 'Contribuidor Ativo',
        description: 'Participou ativamente do f√≥rum',
        icon: 'üåü',
        color: '#8B5CF6',
        criteria: 'Fazer 10 perguntas ou respostas',
      },
    }),
    prisma.badge.upsert({
      where: { name: 'Especialista' },
      update: {},
      create: {
        name: 'Especialista',
        description: 'Alcan√ßou alta reputa√ß√£o no f√≥rum',
        icon: 'üëë',
        color: '#EC4899',
        criteria: 'Alcan√ßar 1000 pontos de reputa√ß√£o',
      },
    }),
  ]);

  console.log(`‚úÖ ${badges.length} badges criadas`);

  // Criar usu√°rio admin
  console.log('üë§ Criando usu√°rio admin...');
  const hashedPassword = await bcrypt.hash('admin123', 12);
  
  const adminUser = await prisma.user.upsert({
    where: { email: 'admin@acodelab.com' },
    update: {},
    create: {
      email: 'admin@acodelab.com',
      username: 'admin',
      name: 'Administrador',
      password: hashedPassword,
      reputation: 1000,
      level: 'MASTER',
      isVerified: true,
      bio: 'Administrador do Acode Lab',
    },
  });

  console.log(`‚úÖ Usu√°rio admin criado: ${adminUser.username}`);

  // Criar usu√°rio de exemplo
  console.log('üë§ Criando usu√°rio de exemplo...');
  const examplePassword = await bcrypt.hash('user123', 12);
  
  const exampleUser = await prisma.user.upsert({
    where: { email: 'user@acodelab.com' },
    update: {},
    create: {
      email: 'user@acodelab.com',
      username: 'devuser',
      name: 'Desenvolvedor Exemplo',
      password: examplePassword,
      reputation: 150,
      level: 'INTERMEDIATE',
      bio: 'Desenvolvedor apaixonado por tecnologia',
      location: 'S√£o Paulo, Brasil',
      website: 'https://exemplo.com',
      github: 'devuser',
    },
  });

  console.log(`‚úÖ Usu√°rio de exemplo criado: ${exampleUser.username}`);

  // Criar algumas perguntas de exemplo
  console.log('‚ùì Criando perguntas de exemplo...');
  const questions = await Promise.all([
    prisma.question.create({
      data: {
        title: 'Como implementar autentica√ß√£o JWT no Next.js?',
        content: 'Estou desenvolvendo uma aplica√ß√£o Next.js e preciso implementar autentica√ß√£o JWT. Quais s√£o as melhores pr√°ticas e como fazer isso de forma segura?',
        slug: 'como-implementar-autenticacao-jwt-no-nextjs',
        authorId: exampleUser.id,
        categoryId: categories[1].id, // Web Development
        tags: {
          create: [
            { tagId: tags[2].id }, // React
            { tagId: tags[4].id }, // TypeScript
            { tagId: tags[5].id }, // Next.js
          ]
        }
      }
    }),
    prisma.question.create({
      data: {
        title: 'Qual a diferen√ßa entre SQL e NoSQL?',
        content: 'Sou iniciante em banco de dados e gostaria de entender melhor as diferen√ßas entre bancos SQL e NoSQL. Quando usar cada um?',
        slug: 'qual-a-diferenca-entre-sql-e-nosql',
        authorId: exampleUser.id,
        categoryId: categories[3].id, // Database
        tags: {
          create: [
            { tagId: tags[6].id }, // PostgreSQL
          ]
        }
      }
    }),
    prisma.question.create({
      data: {
        title: 'Como fazer deploy de uma aplica√ß√£o React no Vercel?',
        content: 'Terminei de desenvolver minha aplica√ß√£o React e quero fazer deploy na Vercel. Qual √© o processo passo a passo?',
        slug: 'como-fazer-deploy-de-uma-aplicacao-react-no-vercel',
        authorId: adminUser.id,
        categoryId: categories[1].id, // Web Development
        tags: {
          create: [
            { tagId: tags[2].id }, // React
            { tagId: tags[5].id }, // Next.js
          ]
        }
      }
    }),
  ]);

  console.log(`‚úÖ ${questions.length} perguntas de exemplo criadas`);

  // Criar algumas respostas de exemplo
  console.log('üí¨ Criando respostas de exemplo...');
  const answers = await Promise.all([
    prisma.answer.create({
      data: {
        content: 'Para implementar JWT no Next.js, recomendo usar o NextAuth.js. √â uma solu√ß√£o robusta e segura que oferece suporte nativo para JWT. Voc√™ pode configurar providers personalizados e gerenciar tokens de forma eficiente.',
        authorId: adminUser.id,
        questionId: questions[0].id,
      }
    }),
    prisma.answer.create({
      data: {
        content: 'SQL √© ideal para dados estruturados e relacionamentos complexos, enquanto NoSQL √© melhor para dados n√£o estruturados e escalabilidade horizontal. Use SQL para aplica√ß√µes financeiras e NoSQL para redes sociais.',
        authorId: adminUser.id,
        questionId: questions[1].id,
      }
    }),
  ]);

  console.log(`‚úÖ ${answers.length} respostas de exemplo criadas`);

  // Atualizar contadores de uso das tags
  console.log('üìä Atualizando contadores de uso das tags...');
  await Promise.all([
    prisma.tag.update({
      where: { id: tags[2].id }, // React
      data: { usageCount: 2 }
    }),
    prisma.tag.update({
      where: { id: tags[4].id }, // TypeScript
      data: { usageCount: 1 }
    }),
    prisma.tag.update({
      where: { id: tags[5].id }, // Next.js
      data: { usageCount: 2 }
    }),
    prisma.tag.update({
      where: { id: tags[6].id }, // PostgreSQL
      data: { usageCount: 1 }
    }),
  ]);

  console.log('‚úÖ Contadores de uso das tags atualizados');

  console.log('üéâ Seed do banco de dados conclu√≠do com sucesso!');
  console.log('\nüìã Resumo:');
  console.log(`- ${categories.length} categorias criadas`);
  console.log(`- ${tags.length} tags criadas`);
  console.log(`- ${badges.length} badges criadas`);
  console.log(`- ${questions.length} perguntas de exemplo criadas`);
  console.log(`- ${answers.length} respostas de exemplo criadas`);
  console.log('\nüîë Credenciais de acesso:');
  console.log('Admin: admin@acodelab.com / admin123');
  console.log('User: user@acodelab.com / user123');
}

main()
  .catch((e) => {
    console.error('‚ùå Erro durante o seed:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
